<link rel="import" href="../polymer/polymer.html"/>
<link rel="import" href="../px-colors-design/colors.html"/>
<link rel="import" href="px-vis-behavior-common.html"/>

<dom-module id="px-vis-register-item">
  <link rel="import" type="css" href="css/px-vis-register-item.css"/>
  <template>
    <span
        class$="{{_mutedToStart(item.name)}}"
        name$="R{{item.name}}"
        on-click="_seriesClicked">
        <span
          class="seriesMarker"
          style$="background-color:{{_returnItemColor(item.name)}};"
          name$="R{{item.name}}">&nbsp;</span>
        <span
          class$="{{_getWrapperClass(type)}}">
        <div
          class="seriesName"
          name$="R{{item.name}}">
          {{_returnTruncatedName(item.name)}}&nbsp;
          <template is="dom-if" if="{{_didTruncate(item.name,truncationLength)}}">
            <px-tooltip delay="500">{{_getName(item.name)}}</px-tooltip>
          </template>
        </div>
        <!-- Display serie data differently depending on x and y axis types -->
        <div class="seriesData" name$="R{{item.name}}">
          <!-- if x axis is number format and show it -->
          <template is="dom-if" if="{{_isOfType(xAxisType, 'linear')}}">
            <numbro-element
              value="[[_returnVal(item, 'x', '&nbsp;/&nbsp')]]"
              format="[[numberFormat]]"
              culture="[[numberFormatCulture]]"
              currency$="[[numberFormatIsCurrency]]"
              default-currency-format="[[numberFormatCurrency]]"
              zero-format="[[numberFormatZero]]">
            </numbro-element>
            <template is="dom-if" if="{{_returnVal(item, 'x')}}">{{_getXUnit(item, completeSeriesConfig.*)}}</template>
            <template is="dom-if" if="[[_returnVal(item, 'x')]]">
              &nbsp;/&nbsp
            </template>
          </template>
          <!-- if x axis is ordinal just display it -->
          <template is="dom-if" if="{{_isOfType(xAxisType, 'ordinal')}}">
            <span>[[_returnVal(item, 'x')]]</span>
              <template is="dom-if" if="{{_returnVal(item, 'x')}}">{{_getXUnit(item, completeSeriesConfig.*)}}</template>
              <template is="dom-if" if="[[_returnVal(item, 'x')]]">
                &nbsp;/&nbsp
              </template>
            </template>
            <!-- if x axis is time don't display it -->

            <!-- if y axis is number format and show it -->
              <template is="dom-if" if="{{_isOfType(yAxisType, 'linear')}}">
                <numbro-element
                  value="[[_returnVal(item, 'y')]]"
                  format="[[numberFormat]]"
                  culture="[[numberFormatCulture]]"
                  currency$="[[numberFormatIsCurrency]]"
                  default-currency-format="[[numberFormatCurrency]]"
                  zero-format="[[numberFormatZero]]">
                </numbro-element>
              </template>
              <!-- if y axis is ordinal just display it -->
              <template is="dom-if" if="{{_isOfType(yAxisType, 'ordinal')}}">
                <span>[[_returnVal(item, 'y')]]</span>
              </template>
              <template is="dom-if" if="{{_returnVal(item, 'y')}}">{{_getYUnit(item, completeSeriesConfig.*)}}</template>
            </div>
          </span>
      </span>
  </template>
</dom-module>

<script>
  Polymer({
    is: 'px-vis-register-item',
    behaviors: [
      PxVisBehavior.formatting,
      commonColors
    ],
    properties: {
      item: {
        type: Object
      }
    },


    /**
     * helper function to set initial classes
     *
     * Adds or removes muted class to those series in the register and sets base classes.
     *
     * @method _mutedToStart
     */
    _mutedToStart: function(name) {
      var baseClasses = (this.type === 'horizontal') ? "series narrow flex flex--row" : "series wide flex flex--row";
      if(this.mutedSeries[name]) {
        return baseClasses + ' muted';
      }
      return baseClasses;
    },

    /**
     * Event function which is fired when a series is clicked.
     *
     * Adds series to mutedSeries property or toggles that key's boolean.
     *
     * @method _seriesClicked
     * @param {e} click event
     */
    _seriesClicked: function(e) {
      var ne = Polymer.dom(e),
          series = ne.rootTarget.getAttribute('name').substr(1);
      // if it doesnt exist, let's add it and set to true
      if( typeof(this.mutedSeries[series]) === 'undefined' ) {
        this.set('mutedSeries.' + series, true);
      } else {
        //if does exist, flip the bit
        this.set('mutedSeries.' + series, !this.mutedSeries[series]);
      }
      this.fire('px-vis-muted-series-updated',
        { 'data': this.mutedSeries[series],
          'dataVar': ('mutedSeries.'+series),
          'method': 'set'
        });
      e.stopPropagation();
    },

    /**
     * Function which takes an index and returns the appropriate dataVisColor
     *
     * `i` is a series index number
     *
     * `rgb(r,g,b)` return the appropriate rgb values based in the series index
     *
     * @method _returnItemColor
     * @param {i}
     * @return {rgb}
     */
    _returnItemColor:function(name) {
      return this.completeSeriesConfig[name]['color'];
    },


    _returnVal: function(item, axis, separator) {
      var key = axis === 'x' ?
        this.completeSeriesConfig[item.name]['x'] : this.completeSeriesConfig[item.name]['y'];
      if(item.value && item.value[key]) {
        return item.value[key] + (separator ? separator : '');
      }
      return null;
    },

    _returnTruncatedName: function(name) {
      return this._truncateName(this._getName(name),this.truncationLength);
    },

    /**
     * dom-if function for series names to decide if it was truncated. If so, add a tooltip showing full name
     *
     * @method _didTruncate
     * @param {str} the original string.
     * @param {len} the truncation length.
     */
    _didTruncate: function(str,len) {
      var name = this._getName(str)
      if(len > 2 && name.length > len) {
        return true;
      }
      return false;
    },


    _getName: function(name) {
      if(this.xAxisType === 'pie') {
        //pie should have only one config bit.
        var key = Object.keys(this.completeSeriesConfig)[0];
        return name[this.completeSeriesConfig[key].y];
      } else {
        return this.completeSeriesConfig[name]['name'];
      }
    },

    _isOfType: function(toTest, type) {
      return toTest === type;
    },

    _getYUnit: function(item, completeSeriesConfig) {
      return this.completeSeriesConfig[item.name] && this.completeSeriesConfig[item.name].yAxisUnit ? this.completeSeriesConfig[item.name].yAxisUnit : '';
    },
  });
</script>
